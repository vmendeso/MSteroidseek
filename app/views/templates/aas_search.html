<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AAS Dopping Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
     <!-- Carregando Plotly manualmente -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="flex h-screen">
    <!-- Barra Lateral -->
    <aside class="w-64 bg-white shadow-lg flex flex-col">
      <!-- Cabe칞alho -->
      <div class="p-6 border-b">
        <h2 class="text-xl font-bold text-gray-800">Par칙metros</h2>
      </div>
      <!-- Controles -->
      <div class="p-6 flex-grow overflow-auto space-y-6">
        <!-- Entrada de nome do composto -->
        <div>
          <label for="exact-mass" class="block text-sm font-medium text-gray-700 mb-1">put exact mass here</label>
          <input id="exact-mass" type="text" placeholder="Digite o nome do composto" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </div>

        <!-- Upload de Arquivo m/z -->
        <div>
          <label for="file-mz" class="block text-sm font-medium text-gray-700 mb-1">Upload m/z file</label>
          <input id="file-mz" type="file" accept=".csv" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
          <p id="mz-upload-status" class="mt-2 text-sm text-green-600"></p>
        </div>
        <!-- Upload de Intensidade -->
        <div>
          <label for="file-intensity" class="block text-sm font-medium text-gray-700 mb-1">Upload relative intensity file</label>
          <input id="file-intensity" type="file" accept=".csv" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
          <p id="intensity-upload-status" class="mt-2 text-sm text-green-600"></p>
        </div>
        <div>
          <button id="plot-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
            游늵 Gerar gr치fico
          </button>
        </div>
      </div>
      <!-- Rodap칠 -->
      <div class="p-6 border-t">
        <button id="run-dopping" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow transition duration-300">
          郊윒잺 Execute Dopping Analysis
        </button>
      </div>
    </aside>
    <!-- Conte칰do Principal -->
    <main class="flex-1 p-10 overflow-y-auto">
      <h1 class="text-3xl font-bold mb-4">AAS Dopping Search</h1>
      <div id="plot-result" class="mt-6 text-xl font-semibold text-blue-800"></div>
      <div id="analysis-result" class="mt-6 text-xl font-semibold text-blue-800"></div>
    </main>
  </div>

  <script>
    let uploadedMzFile = null;
    let uploadedIntensityFile = null;

    // Upload m/z
    const mzInput = document.getElementById('file-mz');
    const mzStatus = document.getElementById('mz-upload-status');
    mzInput.addEventListener('change', async () => {
      const file = mzInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch('/upload-file', { method: 'POST', body: formData });
        const result = await res.json();
        mzStatus.textContent = result.message || 'Arquivo m/z enviado com sucesso.';
        uploadedMzFile = result.filename;
      } catch (error) {
        mzStatus.textContent = 'Erro ao enviar o arquivo m/z.';
        console.error(error);
      }
    });

    // Upload intensidade
    const intensityInput = document.getElementById('file-intensity');
    const intensityStatus = document.getElementById('intensity-upload-status');
    intensityInput.addEventListener('change', async () => {
      const file = intensityInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch('/upload-file', { method: 'POST', body: formData });
        const result = await res.json();
        intensityStatus.textContent = result.message || 'Arquivo de intensidade enviado com sucesso.';
        uploadedIntensityFile = result.filename;
      } catch (error) {
        intensityStatus.textContent = 'Erro ao enviar o arquivo de intensidade.';
        console.error(error);
      }
    });

    // Bot칚o de execu칞칚o

    document.getElementById('plot-button').addEventListener('click', async () => {
      const mz = uploadedMzFile;
      const intensity = uploadedIntensityFile;

      try {
        const response = await fetch('/plot-spectrum', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mz, intensity })
        });
      
        const data = await response.json();
      
        if (!response.ok) {
          document.getElementById('analysis-result').textContent = data.detail || 'Erro ao gerar o gr치fico.';
          return;
        }
        
        console.log("Resposta JSON:", data);
        //document.getElementById('analysis-result').innerHTML = data.plot_html;
        const container = document.getElementById('plot-result');

      // Limpa e insere o HTML
      container.innerHTML = data.plot_html;

      // Reexecuta scripts inseridos dinamicamente
      const scripts = container.querySelectorAll('script');
      scripts.forEach((oldScript) => {
        const newScript = document.createElement('script');
        Array.from(oldScript.attributes).forEach(attr => {
          newScript.setAttribute(attr.name, attr.value);
        });
        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
        oldScript.replaceWith(newScript);
      });
        console.log("HTML recebido:", data.plot_html);
      
      } catch (error) {
        document.getElementById('analysis-result').textContent = 'Erro ao gerar o gr치fico.';
        console.error(error);
      }
    });

    
    document.getElementById('run-dopping').addEventListener('click', async () => {

      const exactMass = document.getElementById('exact-mass').value;
      if (!uploadedMzFile || !uploadedIntensityFile || !exactMass) {
        document.getElementById('analysis-result').textContent = 'Por favor, envie ambos os arquivos.';
        return;
      }
    
      try {
        const res = await fetch('/run-dopping', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mz_file: uploadedMzFile,
            intensity_file: uploadedIntensityFile,
            exact_mass: exactMass
          })
        });
      
        const data = await res.json();

        if (!res.ok) {
          document.getElementById('analysis-result').textContent = data.detail || 'Erro na an치lise.';
          return;
        }

        document.getElementById('analysis-result').textContent = data.result;

    } catch (error) {
      document.getElementById('analysis-result').textContent = 'Erro ao executar an치lise.';
      console.error(error);
    }
    });
  </script>
</body>
</html>
