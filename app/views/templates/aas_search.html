<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AAS Dopping Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="flex h-screen">
    <!-- Barra Lateral -->
    <aside class="w-64 bg-white shadow-lg flex flex-col">
      <!-- Cabeçalho -->
      <div class="p-6 border-b">
        <h2 class="text-xl font-bold text-gray-800">Parâmetros</h2>
      </div>
      <!-- Controles -->
      <div class="p-6 flex-grow overflow-auto space-y-6">
        <!-- Upload de Arquivo m/z -->
        <div>
          <label for="file-mz" class="block text-sm font-medium text-gray-700 mb-1">Upload m/z file</label>
          <input id="file-mz" type="file" accept=".csv" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
          <p id="mz-upload-status" class="mt-2 text-sm text-green-600"></p>
        </div>
        <!-- Upload de Intensidade -->
        <div>
          <label for="file-intensity" class="block text-sm font-medium text-gray-700 mb-1">Upload relative intensity file</label>
          <input id="file-intensity" type="file" accept=".csv" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
          <p id="intensity-upload-status" class="mt-2 text-sm text-green-600"></p>
        </div>
      </div>
      <!-- Rodapé -->
      <div class="p-6 border-t">
        <button id="run-dopping" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow transition duration-300">
          ▶️ Execute Dopping Analysis
        </button>
        <p id="similarity-result" class="mt-3 text-sm text-green-700"></p>
      </div>
    </aside>
    <!-- Conteúdo Principal -->
    <main class="flex-1 p-10 overflow-y-auto">
      <h1 class="text-3xl font-bold mb-4">AAS Dopping Search</h1>
      <div id="svg-container" class="grid grid-cols-1 gap-4"></div>
    </main>
  </div>

  <script>
    let uploadedMzFile = null;
    let uploadedIntensityFile = null;

    // Upload m/z
    const mzInput = document.getElementById('file-mz');
    const mzStatus = document.getElementById('mz-upload-status');
    mzInput.addEventListener('change', async () => {
      const file = mzInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch('/upload-file', { method: 'POST', body: formData });
        const result = await res.json();
        mzStatus.textContent = result.message || 'Arquivo m/z enviado com sucesso.';
        uploadedMzFile = result.filename;
      } catch (error) {
        mzStatus.textContent = 'Erro ao enviar o arquivo m/z.';
        console.error(error);
      }
    });

    // Upload intensidade
    const intensityInput = document.getElementById('file-intensity');
    const intensityStatus = document.getElementById('intensity-upload-status');
    intensityInput.addEventListener('change', async () => {
      const file = intensityInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append('file', file);
      try {
        const res = await fetch('/upload-file', { method: 'POST', body: formData });
        const result = await res.json();
        intensityStatus.textContent = result.message || 'Arquivo de intensidade enviado com sucesso.';
        uploadedIntensityFile = result.filename;
      } catch (error) {
        intensityStatus.textContent = 'Erro ao enviar o arquivo de intensidade.';
        console.error(error);
      }
    });

    // Botão de execução
    document.getElementById('run-dopping').addEventListener('click', async () => {
      if (!uploadedMzFile || !uploadedIntensityFile) {
        document.getElementById('similarity-result').textContent = 'Por favor, envie ambos os arquivos.';
        return;
      }

      try {
        const res = await fetch('/run-similarity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mz_file: uploadedMzFile,
            intensity_file: uploadedIntensityFile
          })
        });

        const data = await res.json();
        document.getElementById('similarity-result').textContent = data.message;
        
        const container = document.getElementById('svg-container');
        container.innerHTML = '';
        data.svg_list.forEach(svg => {
          const div = document.createElement('div');
          div.className = 'bg-white p-4 rounded shadow';
          div.innerHTML = svg;
          container.appendChild(div);
        });

      } catch (error) {
        document.getElementById('similarity-result').textContent = 'Erro ao processar a análise.';
        console.error(error);
      }
    });
  </script>
</body>
</html>
